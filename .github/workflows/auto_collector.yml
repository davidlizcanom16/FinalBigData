name: Auto Data Collector

on:
  schedule:
    # Ejecutar cada 5 minutos (GitHub Actions límite)
    - cron: '*/5 * * * *'
  workflow_dispatch:  # Permite ejecutar manualmente

jobs:
  collect-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        pip install requests pymongo python-dotenv
    
    - name: Run data collector
      env:
        COSMOS_CONNECTION_STRING: ${{ secrets.COSMOS_CONNECTION_STRING }}
      run: |
        # Crear archivo .env temporal
        echo "COSMOS_CONNECTION_STRING=$COSMOS_CONNECTION_STRING" > .env
        
        # Ejecutar collector una vez (1 snapshot)
        python -c "
from data_collector import EcommerceDataCollector
from azure_connector import AzureCosmosConnector

collector = EcommerceDataCollector()
azure = AzureCosmosConnector()

if azure.conectar():
    print('Conectado a Azure')
    datos = collector.recolectar_datos(num_iteraciones=1)
    
    if datos:
        snapshot = datos[0]
        for producto in snapshot['productos']:
            producto['snapshot_id'] = 'auto'
            producto['snapshot_timestamp'] = snapshot['timestamp']
            azure.collection.insert_one(producto)
        
        print(f'✅ {len(snapshot[\"productos\"])} productos insertados')
    
    azure.cerrar_conexion()
"
