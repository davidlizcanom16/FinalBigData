name: Auto Data Collector

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  collect-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        pip install requests pymongo python-dotenv
    
    - name: Run data collector
      env:
        COSMOS_CONNECTION_STRING: ${{ secrets.COSMOS_CONNECTION_STRING }}
      run: |
        echo "COSMOS_CONNECTION_STRING=$COSMOS_CONNECTION_STRING" > .env
        python3 << 'PYTHON_SCRIPT'
from data_collector import EcommerceDataCollector
from azure_connector import AzureCosmosConnector
import sys

try:
    collector = EcommerceDataCollector()
    azure = AzureCosmosConnector()
    
    if azure.conectar():
        print('✅ Conectado a Azure')
        datos = collector.recolectar_datos(num_iteraciones=1)
        
        if datos:
            snapshot = datos[0]
            snapshot_id = snapshot.get('snapshot_id', 1)
            
            for producto in snapshot['productos']:
                producto['snapshot_id'] = snapshot_id
                producto['snapshot_timestamp'] = snapshot['timestamp']
                azure.collection.insert_one(producto)
            
            print(f'✅ {len(snapshot["productos"])} productos insertados')
        else:
            print('❌ No se pudieron recolectar datos')
            sys.exit(1)
        
        azure.cerrar_conexion()
    else:
        print('❌ No se pudo conectar a Azure')
        sys.exit(1)
        
except Exception as e:
    print(f'❌ Error: {e}')
    import traceback
    traceback.print_exc()
    sys.exit(1)
PYTHON_SCRIPT
